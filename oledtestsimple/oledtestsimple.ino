#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

#define OLED_RESET     -1 
#define SCREEN_ADDRESS 0x3C 
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

#define FRAME_DELAY (42)
#define FRAME_WIDTH (32)
#define FRAME_HEIGHT (32)
#define FRAME_COUNT (sizeof(frames) / sizeof(frames[0]))

/*const unsigned char wifiicon[] PROGMEM  ={ // wifi icon
  0x7e, 0x81, 0x3c, 0x42, 0x18, 0x24,0x00, 0x18
};*/

const byte PROGMEM frames[][128] = {
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,128,0,0,3,192,0,0,7,64,0,0,6,96,0,0,12,48,0,0,12,48,0,0,24,24,0,0,24,8,0,0,48,12,0,0,97,132,0,0,97,134,0,0,193,131,0,0,193,131,0,1,129,129,128,3,129,128,128,3,1,128,192,6,1,128,64,6,1,128,96,12,1,128,48,12,0,0,16,24,0,0,24,56,1,128,8,48,1,128,12,96,0,0,4,96,0,0,6,192,0,0,3,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,48,12,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,1,0,24,48,1,128,8,48,1,128,12,96,0,0,4,192,0,0,6,255,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,6,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,192,6,1,128,192,6,1,128,96,12,1,128,32,12,0,128,48,24,0,0,16,48,1,128,24,48,1,128,8,96,1,128,12,96,0,0,6,192,0,0,6,255,255,255,255,0,15,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,0,0,24,48,1,128,8,112,1,128,12,96,0,0,4,192,0,0,6,255,255,255,227,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,24,24,1,128,24,48,1,128,12,112,1,128,4,96,0,0,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,6,1,128,32,12,1,128,48,12,0,0,24,24,0,0,24,56,1,128,12,48,1,128,4,96,0,0,6,96,0,0,3,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,6,192,0,0,6,96,0,0,12,32,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,225,130,0,0,193,131,0,1,129,129,128,1,129,128,128,3,1,128,192,3,1,128,64,6,1,128,96,6,1,128,48,12,1,128,16,28,0,0,24,24,0,0,8,48,1,128,12,48,1,128,6,96,0,0,2,96,0,0,3,255,255,255,255,255,255,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,28,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,0,193,129,0,1,129,129,128,3,1,128,192,3,1,128,192,6,1,128,96,6,1,128,32,12,1,128,48,12,0,0,24,24,0,0,24,56,1,128,12,48,1,128,4,96,1,128,6,96,0,0,2,199,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,192,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,225,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,24,24,0,0,24,48,1,128,12,48,1,128,4,96,1,128,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,0,0,24,48,1,128,8,112,1,128,12,96,1,128,4,192,0,0,6,255,255,255,227,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,128,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,6,32,0,0,12,48,0,0,24,24,0,0,24,8,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,192,6,1,128,192,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,16,48,0,0,24,48,1,128,8,96,1,128,12,96,1,128,6,192,0,0,6,255,255,255,255,0,1,255,255,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,1,128,16,24,0,0,24,48,1,0,8,112,1,128,12,96,1,128,4,192,0,0,6,255,255,255,255,255,255,255,255,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,49,140,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,24,24,0,0,24,48,1,128,12,112,1,128,4,96,1,128,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,28,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,0,193,129,0,1,129,129,128,3,1,128,192,3,1,128,192,6,1,128,96,6,1,128,32,12,1,128,48,12,1,128,24,24,0,0,24,56,0,0,12,48,1,128,4,96,1,128,6,96,0,0,2,199,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,7,192,0,0,6,96,0,0,12,32,0,0,12,48,0,0,24,16,0,0,24,24,0,0,49,12,0,0,49,132,0,0,97,134,0,0,225,130,0,0,193,131,0,1,129,129,128,1,129,128,128,3,1,128,192,3,1,128,64,6,1,128,96,6,1,128,48,12,1,128,16,28,0,0,24,24,0,0,8,48,1,128,12,48,1,192,6,96,1,128,2,96,0,0,3,255,255,255,255,255,255,224,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,28,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,0,193,129,0,1,129,129,128,3,1,128,192,3,1,128,192,6,1,128,96,6,1,128,32,12,1,128,48,12,1,128,24,24,0,0,24,56,0,0,12,48,1,128,4,96,1,128,6,96,0,0,2,199,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,49,140,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,24,24,0,0,24,48,1,128,12,112,1,128,4,96,1,128,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,1,128,16,24,0,0,24,48,1,0,8,112,1,128,12,96,1,128,4,192,0,0,6,255,255,255,255,255,255,255,255,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,128,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,6,32,0,0,12,48,0,0,24,24,0,0,24,8,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,192,6,1,128,192,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,16,48,0,0,24,48,1,128,8,96,1,128,12,96,1,128,6,192,0,0,6,255,255,255,255,0,1,255,255,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,0,0,24,48,1,128,8,112,1,128,12,96,1,128,4,192,0,0,6,255,255,255,227,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,192,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,225,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,1,128,48,24,0,0,24,24,0,0,24,48,1,128,12,48,1,128,4,96,0,0,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,28,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,0,193,129,0,1,129,129,128,3,1,128,192,3,1,128,192,6,1,128,96,6,1,128,32,12,1,128,48,12,0,0,24,24,0,0,24,56,1,128,12,48,1,128,4,96,0,128,6,96,0,0,2,199,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,6,192,0,0,6,96,0,0,12,32,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,225,130,0,0,193,131,0,1,129,129,128,1,129,128,128,3,1,128,192,3,1,128,64,6,1,128,96,6,1,128,48,12,1,128,16,28,0,0,24,24,1,128,8,48,1,128,12,48,1,128,6,96,0,0,2,96,0,0,3,255,255,255,255,255,255,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,128,0,0,3,192,0,0,6,64,0,0,6,96,0,0,12,48,0,0,24,16,0,0,24,24,0,0,48,8,0,0,49,140,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,6,1,128,32,12,1,128,48,12,0,0,24,24,0,0,24,56,1,128,12,48,1,128,4,96,0,0,6,96,0,0,3,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,14,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,128,1,129,129,128,3,1,128,192,3,1,128,64,6,1,128,96,12,1,128,32,12,0,0,48,24,0,0,24,24,1,128,24,48,1,128,12,112,1,128,4,96,0,0,6,192,0,0,2,255,255,255,255,255,255,255,254,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,48,12,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,1,0,24,48,1,128,8,112,1,128,12,96,0,0,4,192,0,0,6,255,255,255,227,255,255,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,3,192,0,0,3,64,0,0,6,96,0,0,6,32,0,0,12,48,0,0,24,24,0,0,24,24,0,0,48,12,0,0,49,132,0,0,97,134,0,0,193,130,0,0,193,131,0,1,129,129,0,1,129,129,128,3,1,128,192,6,1,128,192,6,1,128,96,12,1,128,32,12,0,0,48,24,0,0,16,48,1,128,24,48,1,128,8,96,0,0,12,96,0,0,6,192,0,0,6,255,255,255,255,0,15,255,255,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,128,0,0,1,192,0,0,3,192,0,0,6,96,0,0,6,32,0,0,12,48,0,0,12,16,0,0,24,24,0,0,48,8,0,0,48,12,0,0,97,134,0,0,97,130,0,0,193,131,0,1,193,129,0,1,129,129,128,3,1,128,128,3,1,128,192,6,1,128,96,14,1,128,96,12,1,128,48,24,0,0,16,24,1,128,24,48,1,128,8,48,1,128,12,96,0,0,4,192,0,0,6,255,255,255,255,255,255,255,255,0,0,0,0,0,0,0,0}
};

void setup() {
  Serial.begin(9600);

  display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS);
}

int frame = 0;

void loop() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.print("Power Meter");
  display.println();
  display.drawBitmap(8, 16, frames[frame], FRAME_WIDTH, FRAME_HEIGHT, 1);
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(48,24);display.print("Overvoltage");
  display.setCursor(48,36);display.print("265.00V");
  display.display();
  frame = (frame + 1) % FRAME_COUNT;
  delay(FRAME_DELAY);

  //anim();
}

void anim() {
  display.clearDisplay();
  display.drawBitmap(48, 16, frames[frame], FRAME_WIDTH, FRAME_HEIGHT, 1);
  display.display();
  frame = (frame + 1) % FRAME_COUNT;
  delay(FRAME_DELAY);
}

/*void disp1() {
  display.drawBitmap(120,0,wifiicon,8,8,WHITE);
  display.display();

  display.setTextSize(1);             // Normal 1:1 pixel scale
  display.setTextColor(SSD1306_WHITE);        // Draw white text
  display.setCursor(0,0);
  display.println("IoT Based Power Meter");
  display.display();

  display.setTextSize(1);
  display.println();
  display.print("Voltage:   ");
  display.print(voltage,1);
  display.println(" V");
  display.display();

  display.print("Current:   ");
  display.print(current,3);
  display.println(" A");
  display.display();

  display.print("Power:     ");
  display.print(power,1);
  display.println(" W");
  display.display();

  display.print("Usage:     ");
  display.print(energy,2);
  display.println(" kWh");
  display.display();

  display.print("Freq.:     ");
  display.print(frequency,1);
  display.println(" Hz");
  display.display();

  display.print("PF:        ");
  display.print(pf,2);
  display.display();

  display.setTextSize(2);
  display.setCursor(38,16); display.println("Error");
  display.setCursor(27,32); display.println("Reading");
  display.setTextSize(1);
  display.setCursor(29,48); display.print("No Power Supply");
  display.display();
}*/

/*void disp2() {
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.print("P: ");
  display.print(p);
  display.display();

  if(p == 2){
    p = 0;
  } else {
    ++p;
  }
}*/